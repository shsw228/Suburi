name: Format

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]
    workflow_dispatch:
        inputs:
            whole_format:
                type: boolean
                description: プロジェクト全体をフォーマットするかどうか
                default: false

            
env:
    DEVELOPER_DIR: /Applications/Xcode_16.0.app
jobs:
    format:
        runs-on: macOS-latest
        steps:
            - name: Show Xcode list #Xcodeのリスト書き出し
              run: ls /Applications | grep 'Xcode'
            - name: PR commits + 1
              id: pre_fetch_depth
              run: echo "depth=$(( ${{ github.event.pull_request.commits }} + 1 ))" >> "${GITHUB_OUTPUT}"
            - name: Checkout PR branch and all PR commits
              uses: actions/checkout@v4
              with:
                ref: ${{ github.event.pull_request.head.ref }}
                fetch-depth: ${{ steps.pre_fetch_depth.outputs.depth }} # (PR の commits + 1) 個 checkout する              
              
            - name: Find swift files to format
              if: inputs.whole_format == false
              run: |
                SWIFT_FILES=()
                while IFS="" read -r file; do SWIFT_FILES+=("${file}"); done < <(git diff --name-only --diff-filter=AMRC ${{ github.event.pull_request.base.sha }} -- "*.swift")
                if [ "${#SWIFT_FILES[@]}" -eq 0 ]; then
                echo "No changes to format"
                else
                swift format format --in-place --configuration .swift-format.json --parallel "${SWIFT_FILES[@]}" || true
                fi
            - name: All files to format
              if: inputs.whole_format == true
              run:   swift format format -r . --in-place --configuration .swift-format.json --parallel || true
                
            - name: Commit and Push changes
              env:
                HEAD_REF: ${{ github.head_ref }}
              run: |
                  git config --local user.name "github-actions[bot]"
                  git config --local user.email "13506491+github-actions[bot]@users.noreply.github.com"
                  git add .
                  if git commit -m "[GitHub Actions] swift-format"; then
                    echo "Changes committed, pushing to repository..."
                    git push origin HEAD:"${HEAD_REF}"
                  else
                    echo "No changes to commit"
                  fi
